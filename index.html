<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PubNub Chat SDK Demo (Debug)</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#0b0f14; color:#e6eef8; }
    .chat { display:flex; flex-direction:column; height:100vh; }
    .topbar { padding:8px 16px; background:#111826; border-bottom:1px solid #222; display:flex; justify-content:space-between; }
    .messages { flex:1; overflow-y:auto; padding:16px; }
    .msg { margin-bottom:8px; }
    .msg.me { text-align:right; }
    .bubble { display:inline-block; padding:8px 12px; border-radius:12px; background:#1a2438; color:#fff; }
    .msg.me .bubble { background:#10203a; color:#fff; }
    .composer { display:flex; border-top:1px solid #222; }
    .composer input { flex:1; border:none; padding:12px; background:#0a121c; color:#fff; }
    .composer button { border:none; padding:12px 16px; background:#6ea8fe; color:#08121e; font-weight:bold; }
    #typing { font-size:0.9em; color:#aaa; padding:4px 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@pubnub/chat@0.6.0/dist/chat.umd.min.js"></script>
</head>
<body>
<div class="chat">
  <div class="topbar">
    <div>üí¨ PubNub Chat</div>
    <div id="presenceCount">0 online</div>
  </div>
  <div id="messages" class="messages"></div>
  <div id="typing"></div>
  <form id="composer" class="composer">
    <input id="messageInput" placeholder="Type a message‚Ä¶" autocomplete="off"/>
    <button type="submit">Send</button>
  </form>
</div>

<script>
(async function(){
  const me = prompt("Enter your display name:", "guest-" + Math.floor(Math.random()*1000));
  const subscribeKey = "sub-c-f22ff86e-252f-4592-83ef-17f4d28d7ecc"; // ‚úÖ your key
  const channel = "room-1";

  let chat, space;

  // Step 1: Init
  try {
    chat = await Chat.init({ subscribeKey, userId: me });
    console.log("‚úÖ Chat SDK initialized", chat);
  } catch (err) {
    console.error("‚ùå Failed to initialize PubNub Chat:", err);
    alert("Could not start chat: " + err.message);
    return;
  }

  // Step 2: Join space
  try {
    space = await chat.spaces.join(channel);
    console.log("‚úÖ Joined space:", channel, space);
  } catch (err) {
    console.error("‚ùå Failed to join space:", err);
    alert("Join failed: " + err.message);
    return;
  }

  // Step 3: Load history
  try {
    const history = await space.getMessages({ count: 25 });
    console.log("üìú Loaded history:", history);
    history.messages.forEach(msg =>
      addMessage({author: msg.message.from, text: msg.message.text, mine: msg.message.from===me})
    );
  } catch (err) {
    console.warn("‚ö†Ô∏è History fetch failed:", err);
  }

  // Step 4: Listeners
  space.on("message", (msg) => {
    console.log("üì© Message received:", msg);
    addMessage({author: msg.message.from, text: msg.message.text, mine: msg.message.from===me});
  });

  space.on("membership", (evt) => {
    console.log("üë• Membership event:", evt);
    refreshOnline();
  });

  space.on("signal", (sig) => {
    console.log("‚úçÔ∏è Signal:", sig);
    if(sig.message?.type === "typing" && sig.publisher !== me){
      showTyping(`${sig.publisher} is typing...`);
      clearTimeout(window._typingTimer);
      window._typingTimer = setTimeout(()=>showTyping(""), 1000);
    }
  });

  // Step 5: Send messages
  document.getElementById("composer").onsubmit = async (e) => {
    e.preventDefault();
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text) return;
    input.value = "";
    try {
      const result = await space.publish({ from: me, text });
      console.log("üì§ Published:", result);
    } catch (err) {
      console.error("‚ùå Publish failed:", err);
      alert("Send failed: " + err.message);
    }
  };

  // Step 6: Typing indicator
  document.getElementById("messageInput").addEventListener("input", ()=>{
    space.signal({ type:"typing", user: me }).catch(err=>{
      console.warn("‚ö†Ô∏è Signal failed:", err);
    });
  });

  // Helpers
  function addMessage({author,text,mine}){
    const wrap=document.createElement("div");
    wrap.className="msg"+(mine?" me":"");
    wrap.innerHTML=`<div class="bubble"><b>${author}</b>: ${text}</div>`;
    document.getElementById("messages").appendChild(wrap);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  }
  function showTyping(t){ document.getElementById("typing").textContent = t; }
  async function refreshOnline(){
    try {
      const here = await space.hereNow();
      console.log("üë• HereNow:", here);
      document.getElementById("presenceCount").textContent = `${here.totalOccupancy} online`;
    } catch (e) {
      console.warn("‚ö†Ô∏è Presence fetch failed:", e);
    }
  }
  refreshOnline();
})();
</script>
</body>
</html>
