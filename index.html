<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PubNub Chat Demo</title>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#0b0f14; color:#e6eef8; }
    .chat { display:flex; flex-direction:column; height:100vh; }
    .topbar { padding:8px 16px; background:#111826; border-bottom:1px solid #222;
              display:flex; justify-content:space-between; }
    .messages { flex:1; overflow-y:auto; padding:16px; }
    .msg { margin-bottom:8px; }
    .msg.me { text-align:right; }
    .bubble { display:inline-block; padding:8px 12px; border-radius:12px;
              background:#1a2438; color:#fff; }
    .msg.me .bubble { background:#10203a; color:#fff; }
    .composer { display:flex; border-top:1px solid #222; }
    .composer input { flex:1; border:none; padding:12px; background:#0a121c; color:#fff; }
    .composer button { border:none; padding:12px 16px; background:#6ea8fe;
                       color:#08121e; font-weight:bold; cursor:pointer; }
    #typing { font-size:0.9em; color:#aaa; padding:4px 16px; }
  </style>
</head>
<body>
<div class="chat">
  <div class="topbar">
    <div>üí¨ PubNub Chat</div>
    <div id="presenceCount">0 online</div>
  </div>
  <div id="messages" class="messages"></div>
  <div id="typing"></div>
  <form id="composer" class="composer">
    <input id="messageInput" placeholder="Type a message‚Ä¶" autocomplete="off"/>
    <button type="submit">Send</button>
  </form>
</div>

<script>
const me = prompt("Enter your display name:", "guest-" + Math.floor(Math.random()*1000));
const channel = "room-1";

// ‚úÖ Initialize PubNub
const pubnub = new PubNub({
  subscribeKey: "sub-c-f22ff86e-252f-4592-83ef-17f4d28d7ecc",
  publishKey: "pub-c-acd54e50-42a9-4ac5-bd2e-442ed8e5541f",
  uuid: me
});

// ‚úÖ Listeners
pubnub.addListener({
  message: evt => {
    console.log("üì© message", evt);
    const { from, text } = evt.message;
    addMessage({ author: from, text, mine: from === me });
  },
  presence: evt => {
    console.log("üë• presence", evt);
    refreshOnline();
  },
  signal: evt => {
    console.log("‚úçÔ∏è signal", evt);
    if (evt.message?.type === "typing" && evt.publisher !== me) {
      showTyping(`${evt.publisher} is typing‚Ä¶`);
      clearTimeout(window._typingTimer);
      window._typingTimer = setTimeout(()=>showTyping(""), 1000);
    }
  },
  status: evt => console.log("‚ÑπÔ∏è status", evt)
});

// ‚úÖ Subscribe with presence
pubnub.subscribe({ channels: [channel], withPresence: true });

// ‚úÖ Load history (last 20)
(async ()=>{
  try {
    const hist = await pubnub.fetchMessages({ channels:[channel], count:20 });
    const msgs = hist.channels[channel] || [];
    msgs.forEach(m => {
      addMessage({ author: m.message.from, text: m.message.text, mine: m.message.from === me });
    });
  } catch(e) { console.warn("‚ö†Ô∏è history failed", e); }
})();

// ‚úÖ Send message
document.getElementById("composer").onsubmit = async (e) => {
  e.preventDefault();
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";
  try {
    await pubnub.publish({ channel, message: { from: me, text } });
  } catch(err) {
    console.error("‚ùå publish failed", err);
    alert("Message send failed: " + err.message);
  }
};

// ‚úÖ Typing signal
document.getElementById("messageInput").addEventListener("input", ()=>{
  pubnub.signal({ channel, message: { type:"typing", user: me } })
    .catch(err => console.warn("‚ö†Ô∏è signal failed", err));
});

// ‚úÖ Helpers
function addMessage({author,text,mine}) {
  const wrap = document.createElement("div");
  wrap.className = "msg" + (mine ? " me":"");
  wrap.innerHTML = `<div class="bubble"><b>${author}</b>: ${text}</div>`;
  document.getElementById("messages").appendChild(wrap);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}
function showTyping(t){ document.getElementById("typing").textContent = t; }
async function refreshOnline(){
  try {
    const here = await pubnub.hereNow({ channels:[channel] });
    document.getElementById("presenceCount").textContent = `${here.totalOccupancy} online`;
  } catch(e){ console.warn("‚ö†Ô∏è presence failed", e); }
}
</script>
</body>
</html>
